<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Walley | Transaction</title>
    <link rel="stylesheet" th:href="@{/css/app.css}" />

    <meta name="appCtx" th:content="@{/}" />
</head>
<body>

<nav>
    <a th:href="@{/transactions}">Transactions</a>
    <a th:href="@{/categories}">Categories</a>
    <a th:if="${isAdmin}" th:href="@{/admin/users}">Admin: Users</a>

    <form th:action="@{/logout}" method="post" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit">Logout</button>
    </form>
</nav>

<h2 th:text="${form.id != null ? 'Edit transaction' : 'New transaction'}"></h2>


<div id="noCatBox"
     style="margin: 12px 0; padding: 10px; border: 1px solid #ccc; display:none;"
     th:style="${noCategories} ?
        'margin: 12px 0; padding: 10px; border: 1px solid #ccc; display:block;' :
        'margin: 12px 0; padding: 10px; border: 1px solid #ccc; display:none;'">
    <b>No categories found</b> for the selected type. Create at least one category first.
    <div style="margin-top:8px;">
        <a th:href="@{/categories}">Go to Categories</a>
    </div>
</div>

<form th:object="${form}"
      th:with="actionUrl=${form.id != null} ? '/transactions/' + form.id : '/transactions'"
      th:action="@{${actionUrl}}"
      method="post">

    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <div style="margin: 10px 0;">
        <label for="type">Type</label><br/>
        <select id="type" th:field="*{type}">
            <option th:each="t : ${types}" th:value="${t}" th:text="${t}"></option>
        </select>
        <div th:if="${#fields.hasErrors('type')}" th:errors="*{type}" style="color:#b00020;"></div>
    </div>

    <div style="margin: 10px 0;">
        <label for="amount">Amount</label><br/>
        <input id="amount" type="number" step="0.01" min="0" th:field="*{amount}" />
        <div th:if="${#fields.hasErrors('amount')}" th:errors="*{amount}" style="color:#b00020;"></div>
    </div>

    <div style="margin: 10px 0;">
        <label for="date">Date</label><br/>
        <input id="date" type="date" th:field="*{date}" />
        <div th:if="${#fields.hasErrors('date')}" th:errors="*{date}" style="color:#b00020;"></div>
    </div>

    <div style="margin: 10px 0;">
        <label for="categoryId">Category</label><br/>
        <select id="categoryId" th:field="*{categoryId}" th:disabled="${noCategories}">
            <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
        </select>
        <div th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}" style="color:#b00020;"></div>
    </div>

    <div style="margin: 10px 0;">
        <label for="subcategoryId">Subcategory</label><br/>
        <select id="subcategoryId" th:field="*{subcategoryId}" th:disabled="${noCategories}">
            <option value="">-- none --</option>
            <option th:each="s : ${subcategories}" th:value="${s.id}" th:text="${s.name}"></option>
        </select>
        <div th:if="${#fields.hasErrors('subcategoryId')}" th:errors="*{subcategoryId}" style="color:#b00020;"></div>
    </div>

    <div style="margin: 10px 0;">
        <label for="note">Note</label><br/>
        <input id="note" type="text" maxlength="255" th:field="*{note}" />
        <div th:if="${#fields.hasErrors('note')}" th:errors="*{note}" style="color:#b00020;"></div>
    </div>

    <div style="margin-top: 14px;">
        <button id="saveBtn" type="submit" th:disabled="${noCategories}">Save</button>
        <a th:href="@{/transactions}" style="margin-left:10px;">Cancel</a>
    </div>
</form>

<script>
    (() => {
        const typeEl = document.getElementById('type');
        const catEl  = document.getElementById('categoryId');
        const subEl  = document.getElementById('subcategoryId');
        const saveBtn = document.getElementById('saveBtn');
        const noCatBox = document.getElementById('noCatBox');

        if (!typeEl || !catEl || !subEl) return;

        const base = (document.querySelector('meta[name="appCtx"]')?.content || '/');

        function setSaveEnabled(enabled) {
            if (saveBtn) saveBtn.disabled = !enabled;
        }

        function showNoCategories(show) {
            if (noCatBox) noCatBox.style.display = show ? 'block' : 'none';
        }

        async function fetchJson(url) {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        function setOptions(select, items, selectedValue, includeEmpty) {
            select.innerHTML = '';

            if (includeEmpty) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = '-- none --';
                select.appendChild(opt);
            }

            for (const it of items) {
                const opt = document.createElement('option');
                opt.value = String(it.id);
                opt.textContent = it.name;
                select.appendChild(opt);
            }

            if (selectedValue != null && selectedValue !== '') {
                select.value = String(selectedValue);
            }
        }

        async function loadCategories(selectedCatId) {
            const type = typeEl.value;
            const cats = await fetchJson(`${base}api/categories?type=${encodeURIComponent(type)}`);

            if (!cats || cats.length === 0) {
                catEl.innerHTML = '';
                catEl.disabled = true;

                setOptions(subEl, [], '', true);
                subEl.disabled = true;

                setSaveEnabled(false);
                showNoCategories(true);
                return null;
            }

            catEl.disabled = false;

            const initial = selectedCatId ?? cats[0].id;
            setOptions(catEl, cats, initial, false);

            setSaveEnabled(true);
            showNoCategories(false);

            return catEl.value;
        }

        async function loadSubcategories(categoryId, selectedSubId) {
            if (!categoryId) {
                setOptions(subEl, [], '', true);
                subEl.disabled = true;
                return;
            }

            const subs = await fetchJson(`${base}api/categories/${categoryId}/subcategories`);
            subEl.disabled = false;
            setOptions(subEl, subs ?? [], selectedSubId ?? '', true);
        }


        typeEl.addEventListener('change', async () => {
            try {
                const catId = await loadCategories(null);
                await loadSubcategories(catId, null);
            } catch (e) {
                console.error(e);
            }
        });


        catEl.addEventListener('change', async () => {
            try {
                await loadSubcategories(catEl.value, null);
            } catch (e) {
                console.error(e);
            }
        });


        (async () => {
            try {
                const existingCat = catEl.value || null;
                const existingSub = subEl.value || null;

                const catId = await loadCategories(existingCat);
                await loadSubcategories(catId, existingSub);
            } catch (e) {
                console.error(e);
            }
        })();
    })();
</script>

</body>
</html>

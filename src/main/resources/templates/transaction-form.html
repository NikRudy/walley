<!DOCTYPE html>
<title>Walley | Transaction</title>
<link rel="stylesheet" th:href="@{/css/app.css}" />
</head>
<body>
<nav>
    <a th:href="@{/transactions}">Back</a>
</nav>


<h2 th:text="${form.id == null ? 'New transaction' : 'Edit transaction'}"></h2>


<form th:action="${form.id == null ? '/transactions' : '/transactions/' + form.id}"
      th:object="${form}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>


    <div>
        <label>Type</label>
        <select th:field="*{type}" id="typeSelect">
            <option th:each="t : ${types}" th:value="${t}" th:text="${t}"></option>
        </select>
        <div class="error" th:if="${#fields.hasErrors('type')}" th:errors="*{type}"></div>
    </div>


    <div>
        <label>Amount</label>
        <input type="text" th:field="*{amount}" />
        <div class="error" th:if="${#fields.hasErrors('amount')}" th:errors="*{amount}"></div>
    </div>


    <div>
        <label>Date</label>
        <input type="date" th:field="*{date}" />
        <div class="error" th:if="${#fields.hasErrors('date')}" th:errors="*{date}"></div>
    </div>


    <div>
        <label>Category</label>
        <select th:field="*{categoryId}" id="categorySelect">
            <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
        </select>
        <div class="error" th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}"></div>
        <div class="small">Категории фильтруются по типу (INCOME/EXPENSE).</div>
    </div>


    <div>
        <label>Subcategory</label>
        <select th:field="*{subcategoryId}" id="subSelect">
            <option value="">-- none --</option>
            <option th:each="s : ${subcategories}" th:value="${s.id}" th:text="${s.name}"></option>
        </select>
    </div>


    <div>
        <label>Note</label>
        <input type="text" th:field="*{note}" />
    </div>


    <button type="submit">Save</button>
</form>


<script>
    async function reloadSubcategories() {
        const catId = document.getElementById('categorySelect').value;
        const subSelect = document.getElementById('subSelect');


// очистка
        subSelect.innerHTML = '';
        const optNone = document.createElement('option');
        optNone.value = '';
        optNone.textContent = '-- none --';
        subSelect.appendChild(optNone);


        if (!catId) return;


        const res = await fetch('/api/categories/' + catId + '/subcategories');
        if (!res.ok) return;
        const data = await res.json();


        for (const s of data) {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.name;
            subSelect.appendChild(opt);
        }
    }


    document.getElementById('categorySelect').addEventListener('change', reloadSubcategories);
</script>


</body>
</html>
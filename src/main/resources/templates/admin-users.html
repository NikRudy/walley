<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8" />
    <title>Walley | Admin Users</title>
    <link rel="stylesheet" th:href="@{/css/app.css}" />
</head>
<body>
<nav>
    <a th:href="@{/transactions}">Transactions</a>
    <a th:href="@{/categories}">Categories</a>
    <a th:href="@{/admin/users}">Admin: Users</a>
    <form th:action="@{/logout}" method="post" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit">Logout</button>
    </form>
</nav>

<h2>Users</h2>
<a th:href="@{/admin/users/new}">+ New user</a>

<hr/>

<section style="margin: 14px 0;">
    <h3>Admin: Export / Import (All users transactions)</h3>

    <!-- status panel -->
    <div id="importStatus"
         style="display:none; margin:10px 0; padding:10px; border:1px solid #ccc;">
        <b id="importStatusTitle"></b>
        <div id="importStatusBody" style="margin-top:6px;"></div>
    </div>

    <div style="display:flex; gap:18px; flex-wrap: wrap; align-items:flex-start; margin-top:10px;">

        <!-- EXPORT -->
        <div style="padding: 10px; border: 1px solid #ccc; min-width: 260px;">
            <div style="font-weight: 600; margin-bottom: 8px;">Download</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <a th:href="@{/admin/export/all-transactions.csv}">
                    <button type="button">Download CSV</button>
                </a>

                <a th:href="@{/admin/export/all-transactions.json}">
                    <button type="button">Download JSON</button>
                </a>
            </div>

            <p class="small" style="margin-top:10px;">
                Exports all transactions of all users (ADMIN only).
            </p>
        </div>

        <!-- IMPORT CSV (AJAX) -->
        <div style="padding: 10px; border: 1px solid #ccc; min-width: 340px;">
            <div style="font-weight: 600; margin-bottom: 8px;">Upload CSV</div>

            <form class="ajax-import"
                  data-kind="CSV"
                  th:action="@{/admin/export/import/all-transactions/csv}"
                  method="post"
                  enctype="multipart/form-data">

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <input type="file" name="file" accept=".csv,text/csv" required />
                <button type="submit" style="margin-left:10px;">Upload CSV</button>
            </form>

            <p class="small" style="margin-top:10px; margin-bottom:0;">
                CSV header:
                <code>username,type,amount,date,category,subcategory,note</code>
            </p>
        </div>

        <!-- IMPORT JSON (AJAX) -->
        <div style="padding: 10px; border: 1px solid #ccc; min-width: 340px;">
            <div style="font-weight: 600; margin-bottom: 8px;">Upload JSON</div>

            <form class="ajax-import"
                  data-kind="JSON"
                  th:action="@{/admin/export/import/all-transactions/json}"
                  method="post"
                  enctype="multipart/form-data">

                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <input type="file" name="file" accept=".json,application/json" required />
                <button type="submit" style="margin-left:10px;">Upload JSON</button>
            </form>

            <p class="small" style="margin-top:10px; margin-bottom:0;">
                JSON = array of objects:
                <code>username,type,amount,date,category,subcategory,note</code>
            </p>
        </div>

    </div>
</section>

<hr/>

<table class="table">
    <thead>
    <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Role</th>
        <th>Enabled</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="u : ${users}">
        <td th:text="${u.id}"></td>
        <td th:text="${u.username}"></td>
        <td th:text="${u.role}"></td>
        <td th:text="${u.enabled}"></td>
        <td>
            <a th:href="@{/admin/users/{id}/edit(id=${u.id})}">Edit</a>
            <form th:action="@{/admin/users/{id}/delete(id=${u.id})}" method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit">Delete</button>
            </form>
        </td>
    </tr>
    </tbody>
</table>

<p class="small">Доступно только ADMIN.</p>

<script>
    (() => {
        const statusBox = document.getElementById('importStatus');
        const statusTitle = document.getElementById('importStatusTitle');
        const statusBody = document.getElementById('importStatusBody');

        function showStatus(ok, title, bodyHtml) {
            statusBox.style.display = 'block';
            statusBox.style.borderColor = ok ? '#2e7d32' : '#b00020';
            statusTitle.style.color = ok ? '#2e7d32' : '#b00020';
            statusTitle.textContent = title;
            statusBody.innerHTML = bodyHtml || '';
            // прокрутка к сообщению, чтобы сразу было видно результат
            statusBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function readResponseBody(res) {
            const ct = (res.headers.get('content-type') || '').toLowerCase();
            if (ct.includes('application/json')) {
                try { return JSON.stringify(await res.json(), null, 2); } catch { return ''; }
            }
            try { return await res.text(); } catch { return ''; }
        }

        document.querySelectorAll('form.ajax-import').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const kind = form.getAttribute('data-kind') || 'FILE';
                const submitBtn = form.querySelector('button[type="submit"]');
                const fileInput = form.querySelector('input[type="file"][name="file"]');

                if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                    showStatus(false, `${kind} import failed`, 'Please choose a file.');
                    return;
                }

                const originalBtnText = submitBtn ? submitBtn.textContent : null;
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Uploading...';
                }

                showStatus(true, `${kind} import`, 'Uploading file...');

                try {
                    const res = await fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'Accept': 'application/json, text/plain, */*' }
                    });

                    const body = await readResponseBody(res);

                    if (!res.ok) {
                        showStatus(false, `${kind} import failed`,
                            `<div>Status: ${res.status} ${res.statusText}</div>` +
                            (body ? `<pre style="white-space:pre-wrap;margin-top:8px;">${escapeHtml(body)}</pre>` : '')
                        );
                        return;
                    }

                    // успех
                    showStatus(true, `${kind} import completed`,
                        body
                            ? `<div>Server response:</div><pre style="white-space:pre-wrap;margin-top:8px;">${escapeHtml(body)}</pre>`
                            : `<div>Upload succeeded.</div>`
                    );

                    // очистить поле файла
                    form.reset();

                } catch (err) {
                    showStatus(false, `${kind} import failed`, `<div>${escapeHtml(String(err))}</div>`);
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalBtnText;
                    }
                }
            });
        });

        // минимальный escape для вывода текста в <pre>
        function escapeHtml(str) {
            return (str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }
    })();
</script>

</body>
</html>
